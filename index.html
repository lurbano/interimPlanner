<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interim Planner</title>
    <style>
        .interimSession {
            /* width: 20%;
            min-height: 5em; */
            border: 3px inset red;
        }
        .calendarGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, minmax(5em, auto)); 
        }
        .studentTag {
            border: 1px solid black;
            width: fit-content;
            padding: 2px;
            border-radius: 2px;
            background-color: greenyellow;
            margin: 2px;
        }
        #studentTags {
            display: grid;
        }
    </style>
</head>
<body>
    <!-- <div class="student" draggable="true" id="Danny" ondragstart="dragstartHandler(event)">Danny</div>
    <div class="student" draggable="true" id="Aiden" ondragstart="dragstartHandler(event)">Aiden</div>
    <div class="student" draggable="true" id="Millie" ondragstart="dragstartHandler(event)">Millie</div> -->

    <div id="studentTags"></div>

    <label for="studentSelect">Choose a Student:</label>
    <select id="studentSelect">
    </select>


    <!-- calender grids -->
    <div id="interimOptions">

    </div>

    <!-- <div id="calendarGrid">
        <!-- <div id="Monday_AM" class="interimSession" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)"></div>
        <div id="Monday_PM" class="interimSession" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)"></div> -->
    </div> -->

</body>

<script>
    nSessions = 8;
    studentGrid = document.getElementById("studentTags");
    // studentGrid.style.gridTemplateColumns = `repeat(${nSessions}, 1fr)`;
    students = ["Danny", "Aiden", "Millie"];
    studentTagList = {};


    sessions = ["Monday-AM", "Tuesday-AM", "Wednesday-AM", "Thursday-AM", "Monday-PM", "Tuesday-PM", "Wednesday-PM", "Thursday-PM"];
    interimOptions = ["Cooking", "Makerspace", "Robotics", "Coding", "Other"];
    interimSessionDB = {};



    studentRow = 0;
    studentSelect = document.getElementById("studentSelect");


    for (let student of students){
        createStudentTags(student);
    }

    let studentTags = document.getElementById("studentTags");
    function createStudentTags(student){
        studentTagList[student] = [];
        studentRow += 1;

        for (let i=0; i<nSessions; i++){
            let div = document.createElement("div");
            div.id = student + "_" + (i+1);
            div.classList.add("studentTag");
            div.innerHTML = student;
            div.draggable = true;
            // div.style.gridRow = studentRow;
            div.style.gridColumn = i+1;

            
            // 
            // studentTags.appendChild(div);
            let studentTagObj = {
                div: div,
                location_id: "studentTags",
                row: i+1
            }

            studentTagList[student].push(studentTagObj);
        }

        let opt = document.createElement("option");
        opt.value = student;
        opt.textContent = student;
        studentSelect.appendChild(opt);

    }

    studentSelect.addEventListener("change", function(){
        console.log(this.value);
        studentTags.innerHTML = "";
        for (let tag of studentTagList[this.value]){
            
            if (tag["location_id"] === "studentTags"){
                // console.log(tag["div"].id);
                studentTags.append(tag["div"]);
            }
        }
    })


    // INTERIM OPTIONS    
    for (let iName of interimOptions){
        insertInterimOptions(iName);
    }
    console.log("interimSessionDB", interimSessionDB);

    function insertInterimOptions(interimOption){
        let div = document.createElement("div");
        div.id = interimOption;

        let titleDiv = document.createElement("div");
        titleDiv.innerHTML = `<h2>${interimOption}</h2>`;
        div.appendChild(titleDiv);

        let calendarGrid = document.createElement("div");
        calendarGrid.id = "calendar_" + interimOption;
        calendarGrid.classList.add("calendarGrid");

        interimSessionDB[interimOption] = {};

        for (let sName of sessions) {
            insertSessionDiv(sName, interimOption, calendarGrid);
            interimSessionDB[interimOption][sName] = [];
        }

        div.appendChild(calendarGrid);

        let interimOptions = document.getElementById("interimOptions");
        interimOptions.appendChild(div);
    }

    function insertSessionDiv(sessionName, interimOption, calendarGrid){
        let div = document.createElement("div");
        div.id = "session" + "_" + interimOption + "_" + sessionName;
        div.classList.add("interimSession");

        let titleDiv = document.createElement("div");
        titleDiv.innerHTML = sessionName;
        titleDiv.style.fontWeight = "bold";
        div.appendChild(titleDiv);

        calendarGrid.appendChild(div);
    }




    // function dragstartHandler(ev) {
    //     // Add the target element's id to the data transfer object
    //     ev.dataTransfer.setData("application/my-app", ev.target.id);
    //     ev.dataTransfer.effectAllowed = "move";
    // }

    document.addEventListener("dragstart", function(ev){
        // Add the target element's id to the data transfer object
        ev.dataTransfer.setData("application/my-app", ev.target.id);
        ev.dataTransfer.effectAllowed = "move";
    })

    document.addEventListener("drop", function (ev) {
        ev.preventDefault();

        targetData = ev.target.id.split("_");

        if ( ev.target.id === "studentTags"){
            // Get the id of the target and add the moved element to the target's DOM
            const tagID = ev.dataTransfer.getData("application/my-app");

            ev.target.appendChild(document.getElementById(tagID));

            let info = tagID.split("_");
            let student = info[0];
            console.log("Drop: ", student, tagID, ev.target.id);
            

            //remove from interimSessionDB
            for (let iOpt of interimOptions){
                for (let session of sessions){
                    let index = interimSessionDB[iOpt][session].indexOf(tagID);
                    if (index !== -1){
                        interimSessionDB[iOpt][session].splice(index, 1);
                    }
                }
            }

            //change location in student tag list
            for (let i = 0; i < nSessions; i++) {
                if (studentTagList[student][i]['div'].id === tagID) {
                    studentTagList[student][i]['location_id'] = "studentTags";
                }
                // console.log(studentTagList[student][i] )
            }

        }

        if (targetData[0] === 'session'){
            // Get the id of the target and add the moved element to the target's DOM
            const tagID = ev.dataTransfer.getData("application/my-app");

            ev.target.appendChild(document.getElementById(tagID));

            let info = tagID.split("_");
            let student = info[0];
            console.log("Drop: ", student, tagID, ev.target.id);
            
            //add to interimSessionDB
            let interimOpt = targetData[1];
            let sessionTime = targetData[2];

            console.log("interimOpt:", interimOpt)
            console.log("sessionTime", sessionTime)
            interimSessionDB[interimOpt][sessionTime].push(tagID);
            console.log(interimSessionDB)

            for (let i = 0; i < nSessions; i++) {
                if (studentTagList[student][i]['div'].id === tagID) {
                    studentTagList[student][i]['location_id'] = ev.target.id;
                }
                // console.log(studentTagList[student][i] )
            }
        }
        

    })

    document.addEventListener("dragover", function (ev) {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
    })
 

</script>
</html>